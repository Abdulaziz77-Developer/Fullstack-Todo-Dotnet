@page "/login"
@using Frontend.Services
@using System.IdentityModel.Tokens.Jwt
@using System.Security.Claims
@inject AuthService AuthService
@inject NavigationManager Navigation
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@rendermode InteractiveServer

@* Весь твой HTML остается без изменений *@
<div class="login-container">
    <div class="login-card shadow-lg">
        <div class="login-header">
            <i class="bi bi-person-circle fs-1 text-primary"></i>
            <h2 class="fw-bold">Добро пожаловать</h2>
            <p class="text-muted">Введите данные для входа</p>
        </div>

        <div class="card-body">
            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="emailInput" placeholder="name@example.com" @bind="username">
                <label for="emailInput">Логин</label>
            </div>

            <div class="form-floating mb-3">
                <input type="password" class="form-control" id="passInput" placeholder="Пароль" @bind="password">
                <label for="passInput">Пароль</label>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>@errorMessage</div>
                </div>
            }

            <button class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm mt-3" @onclick="HandleLogin">
                Войти в аккаунт
            </button>
        </div>

        <div class="login-footer text-center mt-4">
            <span class="text-muted">Нет аккаунта?</span>
            <a href="/register" class="text-primary fw-bold text-decoration-none">Зарегистрироваться</a>
        </div>
    </div>
</div>

<style>
    /* Твой стиль без изменений */
    .login-container { display: flex; justify-content: center; align-items: center; min-height: 80vh; background-color: #f8f9fa; }
    .login-card { background: white; padding: 2.5rem; border-radius: 1.5rem; width: 100%; max-width: 450px; border: none; }
    .login-header { text-align: center; margin-bottom: 2rem; }
    .form-control:focus { border-color: #0d6efd; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15); }
    .btn-primary { transition: all 0.3s ease; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(13, 110, 253, 0.3); }
</style>

@code {
    private string username = "";
    private string password = "";
    private string errorMessage = "";

    private async Task HandleLogin()
    {
        errorMessage = "";
        
        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(password))
        {
            errorMessage = "Заполните все поля";
            return;
        }

        var success = await AuthService.Login(username, password);
        
        if (success)
        {
            // 1. Извлекаем токен из хранилища
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            
            if (!string.IsNullOrEmpty(token))
            {
                // 2. Расшифровываем токен (без проверки подписи, просто читаем данные)
                var handler = new JwtSecurityTokenHandler();
                var jwtToken = handler.ReadJwtToken(token);

                // 3. Ищем Claim с ролью
                var role = jwtToken.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role || c.Type == "role")?.Value;

                // 4. Перенаправляем в зависимости от роли
                if (role == "Admin")
                {
                    Navigation.NavigateTo("/admin-dashboard");
                }
                else
                {
                    Navigation.NavigateTo("/my-todos");
                }
            }
        }
        else
        {
            errorMessage = "Неверный логин или пароль";
        }
    }
}